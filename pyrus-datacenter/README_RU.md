## Общие сведения
Рекомендуется ставить pyrus в отдельный namespaces.  
Требования: ingress работает только с ingress-nginx  
  
## Для установки вам нужны следующие параметры которые нужно задать в values.yaml:
* лицензия      .Values.pyrusSetupParam.license
* доменное имя  .Values поле hosts в разделе values-ingress-dir  
  **pyrus будет работать только на первом домене в списке**
* tls сертификат можно добавить следующими способами:  
  - вы можете его добавить вручную и впоследствии сослаться на него в разделе ингреса
  - если вы планируете его ставить через функционал данного chart:  
    добавьте в директорию чарта символическую ссылку на расположение ключевой пары.  
    список файлов должен включат в себя  
    * доменноеИмя.зона.crt - открытый ключ с цепочкой  
    * доменноеИмя.зона.key - закрытый ключ  
    * доменноеИмя.зона.pem - полный комплект выше перечисленного  

## Рекомендованные параметры для ingress-nginx
```
  allow-backend-server-header: "true"
  allow-snippet-annotations: "true"
  proxy_next_upstream: error timeout invalid_header http_502 http_503 http_504
  proxy-stream-timeout: 2m
  proxy-stream-next-upstream-timeout: 5s
  proxy-stream-next-upstream-tries: 7
  upstream-keepalive-time: 20m
```

# PostgreSQL внутри данного чарта
## Настройка резервного копирования и восстановления

Резервное копирование организовано через утилиту [wal-g](https://github.com/wal-g/wal-g).  
Для корректной работы нужно задать параметры .Values.standalonePostgreSQLBackup.

* Для облака yandex необходимо дополнительно задать  
  - AWS_ENDPOINT: https://storage.yandexcloud.net

* Для облака мэйл, AWS_ENDPOINT задаётся в зависимости от типа хранилища.  
  Если горячее хранилище: https://hb.bizmrg.com  
  Если холодное хранилище: https://ib.bizmrg.com  

## Процесс бэкапа

Запуск происходить через pg_cron.  
Полная резервная копия по умолчанию делается в 01:00 PM. Вызовом sql
```
SELECT backup_manage();
```
Остальное время делается инкрементный бэкап в в виде архивирования wal журналов.  
Процесс архивирования журнала запускается после переключения субд на следующий файл журнала.  
Архивирование журналов стартует сам postgres.  
Команда указана в ${PGDATA}/postgresql.conf в опции archive_command.

Планирование полного бэкапа через sql(уже задан по умолчанию)
```
--                    ┌───────────── min (0 - 59)
--                    │ ┌────────────── hour (0 - 23)
--                    │ │ ┌─────────────── day of month (1 - 31)
--                    │ │ │ ┌──────────────── month (1 - 12)
--                    │ │ │ │ ┌───────────────── day of week (0 - 6) (0 to 6 are Sunday to
--                    │ │ │ │ │                  Saturday, or use names; 7 is also Sunday)
--                    * * * * *
SELECT cron.schedule('0 1 * * *', $$SELECT backup_manage()$$);
```
Все задания можно посмотреть sql командой:
```
select * from cron.job;
```

Кол-во полных бэкапов, которые будут сохраняться задаются переменной RETAIN_FIND_FULL.  
WALG_DELTA_MAX_STEPS количество шагов, на которые дельта-бэкап максимально отстаёт 
от base-бэкапа.  
Изменить значений можно указанием аргументов в вызове функции cron.schedule(см.выше).
Значения по умолчанию заданы в DDL SQL функции:
```
CREATE FUNCTION backup_manage (RETAIN_FIND_FULL integer default 7,
                               WALG_DELTA_MAX_STEPS integer default 3)
```

## Восстановление

Для инициации восстановления необходимо указать в ENVIROMENT контейнера базы
credentials и имя точки восстановления. Например для последней точки:
```
- RESTORE_NAME: LATEST
```
Либо вместо LATEST указать имя бэкапа. Список бэкапов с именами можно посмотреть shell командой  
```
wal-g backup-list
```

Бэкап начнётся только если директория ${PGDATA} будет пустой. 
В ином случае, процесс восстановления будет проигнорирован и субд будет пытаться запуститься
из файлов расположенных в данной директории, либо инициализировать чистую базу.

